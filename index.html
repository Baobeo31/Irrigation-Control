<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ESP8266 Irrigation Control</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      text-align: center;
    }

    h1 {
      color: #4CAF50;
    }

    .button {
      padding: 10px 20px;
      margin: 10px;
      background-color: #4CAF50;
      color: white;
      border: none;
      cursor: pointer;
      font-size: 16px;
    }

    .button:hover {
      background-color: #45a049;
    }

    .input-group {
      margin: 20px 0;
    }

    input[type="number"] {
      padding: 10px;
      font-size: 16px;
    }
  </style>
</head>

<body>

  <h1>Máy bơm tự động</h1>
  <button class="button" onclick="loadStatus()">Refresh Data</button>
  <h2>Chế độ hiện tại: <span id="currentMode">Auto</span></h2>
  <button class="button" onclick="toggleMode()">Change Mode</button>

  <div class="input-group">
    <h3>Set Pump Schedule:</h3>
    <label for="startHour">Start Hour:</label>
    <input type="number" id="startHour" min="0" max="23">
    <label for="startMinute">Start Minute:</label>
    <input type="number" id="startMinute" min="0" max="59">
    <br><br>
    <label for="endHour">End Hour:</label>
    <input type="number" id="endHour" min="0" max="23">
    <label for="endMinute">End Minute:</label>
    <input type="number" id="endMinute" min="0" max="59">
    <br><br>
    <button class="button" onclick="setSchedule()">Set Schedule</button>
  </div>

  <div class="input-group">
    <h3>Set Moisture Threshold:</h3>
    <input type="number" id="moistureThreshold" value=min="0" max="100">
    <br><br>
    <button class="button" onclick="setThreshold()">Set Threshold</button>
  </div>

  <div class="input-group">
    <h3>Control Pump:</h3>
    <button class="button" onclick="turnPumpOn()">Turn Pump On</button>
    <button class="button" onclick="turnPumpOff()">Turn Pump Off</button>
  </div>



  <script>
    const ip = "192.168.1.16"; // Thay thế bằng địa chỉ IP của ESP8266
    const token = "remote";  // Token xác thực (phải trùng với authToken trong Arduino)

    // Hàm gửi yêu cầu để chuyển sang chế độ tự động
    function toggleMode() {
      const currentMode = document.getElementById('currentMode').innerText;
      const newMode = currentMode === "Auto" ? "manual" : "auto"; // Đổi chế độ giữa Auto và Manual
      const url = `http://${ip}/mode/${newMode}?token=${token}`; // Thêm token vào URL

      fetch(url)
        .then(response => response.text())
        .then(data => {
          alert(data);
          // Cập nhật trạng thái chế độ trên trang
          document.getElementById('currentMode').innerText = newMode.charAt(0).toUpperCase() + newMode.slice(1);
        })
        .catch(error => {
          alert('Error: ' + error);
        });
    }


    // Hàm thiết lập lịch trình
    function setSchedule() {
      const startHour = document.getElementById('startHour').value;
      const startMinute = document.getElementById('startMinute').value;
      const endHour = document.getElementById('endHour').value;
      const endMinute = document.getElementById('endMinute').value;

      fetch(`http://${ip}/set_schedule?start=${startHour}:${startMinute}&end=${endHour}:${endMinute}&token=${token}`)
        .then(response => response.text())
        .then(data => {
          alert("Schedule updated successfully.");
        }).catch(error => {
          alert("Error: " + error);
        });
    }

    // Hàm thiết lập ngưỡng độ ẩm
    function setThreshold() {
      const threshold = document.getElementById('moistureThreshold').value;
      fetch(`http://${ip}/set_threshold?value=${threshold}&token=${token}`)
        .then(response => response.text())
        .then(data => {
          alert("Moisture threshold updated.");
        }).catch(error => {
          alert("Error: " + error);
        });
    }

    // Hàm bật máy bơm
    function turnPumpOn() {
      fetch(`http://${ip}/pump/on?token=${token}`)
        .then(response => response.text())
        .then(data => {
          alert("Pump is ON");
        }).catch(error => {
          alert("Error: " + error);
        });
    }

    // Hàm tắt máy bơm
    function turnPumpOff() {
      fetch(`http://${ip}/pump/off?token=${token}`)
        .then(response => response.text())
        .then(data => {
          alert("Pump is OFF");
        }).catch(error => {
          alert("Error: " + error);
        });
    }



  </script>


  <script>
    //const ip = "192.168.1.16"; // Địa chỉ IP ESP8266
    //const token = "remote"; // Token xác thực

    // Hàm tải trạng thái từ ESP8266
    function loadStatus() {
      fetch(`http://${ip}/get_status?token=${token}`)
        .then(response => response.json())
        .then(data => {
          // Cập nhật trạng thái chế độ
          document.getElementById('currentMode').innerText = data.currentMode.charAt(0).toUpperCase() + data.currentMode.slice(1);
          // Cập nhật lịch trình
          document.getElementById('startHour').value = data.startHour;
          // document.getElementById('startMinute').value = data.startMinute;
          document.getElementById('endHour').value = data.endHour;
          //document.getElementById('endMinute').value = data.endMinute;
          // Cập nhật ngưỡng độ ẩm
          document.getElementById('moistureThreshold').value = data.moistureThreshold;
          // Hiển thị trạng thái máy bơm
          alert(`Pump is currently ${data.pumpState.toUpperCase()}`);
        })
        .catch(error => {
          alert('Error loading status: ' + error);
        });
    }

    // Gọi loadStatus() khi trang web được tải
    window.onload = loadStatus;
  </script>

</body>

</html>